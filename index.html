<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VS Code-Style Web Editor</title>
    <style>
:root {
    --bg-color: #1e1e1e;
    --sidebar-bg: #252526;
    --editor-bg: #1e1e1e;
    --toolbar-bg: #333333;
    --tab-bar-bg: #2d2d2d;
    --tab-inactive-bg: #2d2d2d;
    --tab-active-bg: #1e1e1e;
    --border-color: #3e3e3e;
    --resizer-color: #3e3e3e;
    --text-color: #cccccc;
    --text-muted: #858585;
    --button-bg: #0e639c;
    --button-hover-bg: #1177bb;
    --console-bg: #1e1e1e;
    --hover-bg: #2a2d2e;
    --activity-bar-bg: #333333;
    --input-bg: #3c3c3c;
}

* { box-sizing: border-box; }

body, html {
    margin: 0; padding: 0; height: 100%; width: 100%;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    color: var(--text-color);
    background-color: var(--bg-color);
    overflow: hidden;
    font-size: 13px;
}

body.is-resizing * {
    user-select: none !important;
    pointer-events: none !important;
}

body.is-resizing .split-resizer {
    pointer-events: all !important;
}

/* TOOLBAR */
.toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: var(--toolbar-bg);
    padding: 0 15px;
    height: 35px;
    border-bottom: 1px solid var(--border-color);
}

.toolbar h1 {
    font-size: 13px;
    margin: 0;
    font-weight: 400;
}

.toolbar .buttons {
    display: flex;
    gap: 8px;
    align-items: center;
}

.toolbar button {
    background-color: var(--button-bg);
    color: white;
    border: none;
    padding: 4px 10px;
    border-radius: 2px;
    cursor: pointer;
    font-size: 12px;
}

.toolbar button:hover {
    background-color: var(--button-hover-bg);
}

.toolbar button.secondary {
    background-color: #3c3c3c;
}

.toolbar button.secondary:hover {
    background-color: #4c4c4c;
}

/* MAIN LAYOUT */
.main-layout {
    display: flex;
    height: calc(100vh - 35px);
}

/* ACTIVITY BAR */
.activity-bar {
    width: 48px;
    background-color: var(--activity-bar-bg);
    border-right: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    padding-top: 5px;
}

.activity-bar-item {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: var(--text-muted);
    border-left: 2px solid transparent;
}

.activity-bar-item:hover {
    color: var(--text-color);
}

.activity-bar-item.active {
    color: var(--text-color);
    border-left-color: var(--button-bg);
}

/* SIDEBAR */
.sidebar {
    width: 250px;
    background-color: var(--sidebar-bg);
    border-right: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
}

.sidebar.collapsed {
    display: none;
}

.sidebar-header {
    padding: 8px 12px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    color: var(--text-muted);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.sidebar-actions {
    display: flex;
    gap: 4px;
}

.sidebar-action-btn {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    padding: 4px;
    font-size: 16px;
}

.sidebar-action-btn:hover {
    color: var(--text-color);
}

.file-tree {
    flex: 1;
    overflow-y: auto;
    padding: 4px 0;
}

.file-tree-item {
    display: flex;
    align-items: center;
    padding: 4px 8px 4px 12px;
    cursor: pointer;
    user-select: none;
}

.file-tree-item:hover {
    background-color: var(--hover-bg);
}

.file-tree-item.active {
    background-color: var(--tab-active-bg);
}

.file-tree-item .icon {
    margin-right: 6px;
    font-size: 14px;
}

/* EDITOR AREA */
.editor-area {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.editor-groups {
    flex: 1;
    display: flex;
    overflow: hidden;
}

.editor-group {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 200px;
    background-color: var(--editor-bg);
}

.editor-group-header {
    display: flex;
    background-color: var(--tab-bar-bg);
    border-bottom: 1px solid var(--border-color);
    height: 35px;
    align-items: flex-end;
}

.editor-tabs {
    display: flex;
    flex: 1;
    overflow-x: auto;
}

.editor-tabs::-webkit-scrollbar {
    height: 0;
}

.editor-tab {
    display: flex;
    align-items: center;
    padding: 0 12px;
    height: 35px;
    background-color: var(--tab-inactive-bg);
    border-right: 1px solid var(--border-color);
    cursor: pointer;
    white-space: nowrap;
    font-size: 13px;
    gap: 8px;
}

.editor-tab:hover {
    background-color: #323233;
}

.editor-tab.active {
    background-color: var(--editor-bg);
}

.editor-tab-close {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 16px;
    height: 16px;
    border-radius: 3px;
    opacity: 0;
    font-size: 18px;
}

.editor-tab:hover .editor-tab-close {
    opacity: 0.6;
}

.editor-tab-close:hover {
    opacity: 1 !important;
    background-color: rgba(255, 255, 255, 0.1);
}

.editor-group-actions {
    display: flex;
    padding: 0 8px;
    gap: 2px;
}

.editor-group-action {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    padding: 4px;
    font-size: 16px;
    width: 22px;
    height: 22px;
    border-radius: 3px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.editor-group-action:hover {
    color: var(--text-color);
    background-color: var(--hover-bg);
}

.editor-content {
    flex: 1;
    position: relative;
    overflow: hidden;
}

.editor-instance {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: none;
}

.editor-instance.active {
    display: block;
}

.preview-container {
    width: 100%;
    height: 100%;
    background-color: white;
}

.preview-container iframe {
    width: 100%;
    height: 100%;
    border: none;
}

.empty-editor {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--text-muted);
}

.split-resizer {
    width: 4px;
    background-color: var(--resizer-color);
    cursor: col-resize;
    flex-shrink: 0;
    z-index: 100;
}

.split-resizer:hover {
    background-color: var(--button-bg);
}

/* CONSOLE */
.console-panel {
    height: 200px;
    border-top: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    background-color: var(--console-bg);
}

.console-panel.collapsed {
    display: none;
}

.console-header {
    display: flex;
    justify-content: space-between;
    padding: 0 12px;
    height: 35px;
    background-color: var(--sidebar-bg);
    border-bottom: 1px solid var(--border-color);
    align-items: center;
}

.console-actions {
    display: flex;
    gap: 8px;
}

.console-actions button {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    padding: 4px 8px;
    font-size: 12px;
}

.console-actions button:hover {
    color: var(--text-color);
}

.console-output {
    flex: 1;
    overflow-y: auto;
    padding: 4px 8px;
    font-family: 'Consolas', 'Monaco', monospace;
    font-size: 12px;
}

.console-entry {
    padding: 2px 0;
    display: flex;
    gap: 8px;
}

.console-entry.log { color: var(--text-color); }
.console-entry.warn { color: #d4ac0d; }
.console-entry.error { color: #cd3131; }

/* MODAL */
.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.6);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.modal-overlay.active {
    display: flex;
}

.modal {
    background-color: var(--sidebar-bg);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    padding: 20px;
    min-width: 400px;
}

.modal h3 {
    margin: 0 0 15px 0;
    font-size: 16px;
}

.modal-input {
    width: 100%;
    padding: 8px;
    background-color: var(--input-bg);
    border: 1px solid var(--border-color);
    color: var(--text-color);
    font-size: 13px;
    margin-bottom: 15px;
}

.modal-input:focus {
    outline: none;
    border-color: var(--button-bg);
}

.modal-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
}

.modal-btn {
    padding: 6px 14px;
    border: none;
    border-radius: 2px;
    cursor: pointer;
    font-size: 13px;
}

.modal-btn.primary {
    background-color: var(--button-bg);
    color: white;
}

.modal-btn.primary:hover {
    background-color: var(--button-hover-bg);
}

.modal-btn.secondary {
    background-color: var(--input-bg);
    color: var(--text-color);
}

.modal-btn.secondary:hover {
    background-color: #4c4c4c;
}

/* SCROLLBAR */
::-webkit-scrollbar {
    width: 10px;
    height: 10px;
}

::-webkit-scrollbar-track {
    background: var(--bg-color);
}

::-webkit-scrollbar-thumb {
    background: #424242;
    border-radius: 5px;
}

::-webkit-scrollbar-thumb:hover {
    background: #4e4e4e;
}
    </style>
</head>
<body>
    <div class="toolbar">
        <h1>Web Code Editor</h1>
        <div class="buttons">
            <button id="run-btn">‚ñ∂ Run</button>
            <button class="secondary" id="save-project-btn">üíæ Save</button>
            <button class="secondary" id="preview-new-tab-btn">üóó Preview</button>
        </div>
    </div>

    <div class="main-layout">
        <div class="activity-bar">
            <div class="activity-bar-item active" title="Explorer">üìÅ</div>
        </div>

        <div class="sidebar">
            <div class="sidebar-header">
                <span>Explorer</span>
                <div class="sidebar-actions">
                    <button class="sidebar-action-btn" id="new-file-btn" title="New File">+</button>
                </div>
            </div>
            <div class="file-tree" id="file-tree"></div>
        </div>

        <div class="editor-area">
            <div class="editor-groups" id="editor-groups"></div>

            <div class="console-panel" id="console-panel">
                <div class="console-header">
                    <span>Console</span>
                    <div class="console-actions">
                        <button id="clear-console-btn">Clear</button>
                        <button id="toggle-console-btn">√ó</button>
                    </div>
                </div>
                <div class="console-output" id="console-output"></div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-overlay">
        <div class="modal">
            <h3 id="modal-title">New File</h3>
            <input type="text" class="modal-input" id="modal-input" placeholder="filename.ext">
            <div class="modal-actions">
                <button class="modal-btn secondary" id="modal-cancel">Cancel</button>
                <button class="modal-btn primary" id="modal-confirm">Create</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>
    <script>
const state = {
    files: {},
    editorGroups: [{ id: 1, tabs: [], activeTab: null }],
    nextGroupId: 2,
    activeGroup: 1,
    consoleOpen: true,
};

const defaultFiles = {
    'index.html': {
        language: 'html',
        content: `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Project</title>
</head>
<body>
    <h1>Hello, World!</h1>
    <button onclick="greet()">Click me</button>
</body>
</html>`,
        model: null,
    },
    'style.css': {
        language: 'css',
        content: `body {
    font-family: system-ui, sans-serif;
    margin: 0;
    padding: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

h1 {
    color: white;
    font-size: 3em;
}

button {
    padding: 12px 24px;
    font-size: 16px;
    background: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}`,
        model: null,
    },
    'script.js': {
        language: 'javascript',
        content: `console.log('App loaded!');

function greet() {
    console.log('Button clicked!');
    alert('Hello from JavaScript!');
}`,
        model: null,
    },
    'üîç Preview': {
        language: null,
        content: '',
        model: null,
        isPreview: true,
    }
};

state.files = { ...defaultFiles };

require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs' }});
require(['vs/editor/editor.main'], function() {
    for (const [filename, file] of Object.entries(state.files)) {
        if (file.language) {
            file.model = monaco.editor.createModel(file.content, file.language);
            file.model.onDidChangeContent(() => {
                file.content = file.model.getValue();
                saveState();
                updatePreview();
            });
        }
    }
    init();
});

function init() {
    loadState();
    renderFileTree();
    renderEditorGroups();
    updatePreview();
    setupEventListeners();
    
    if (state.editorGroups[0].tabs.length === 0) {
        openFile('index.html', 0);
    }
}

function setupEventListeners() {
    document.getElementById('run-btn').addEventListener('click', updatePreview);
    document.getElementById('save-project-btn').addEventListener('click', saveProject);
    document.getElementById('preview-new-tab-btn').addEventListener('click', openPreviewInNewTab);
    document.getElementById('new-file-btn').addEventListener('click', () => showModal());
    document.getElementById('clear-console-btn').addEventListener('click', () => {
        document.getElementById('console-output').innerHTML = '';
    });
    document.getElementById('toggle-console-btn').addEventListener('click', () => {
        state.consoleOpen = !state.consoleOpen;
        document.getElementById('console-panel').classList.toggle('collapsed', !state.consoleOpen);
        saveState();
    });
    
    document.getElementById('modal-cancel').addEventListener('click', hideModal);
    document.getElementById('modal-confirm').addEventListener('click', handleModalConfirm);
    document.getElementById('modal-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleModalConfirm();
    });
    document.getElementById('modal-overlay').addEventListener('click', (e) => {
        if (e.target.id === 'modal-overlay') hideModal();
    });
    
    document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
            e.preventDefault();
            saveProject();
        }
        if ((e.ctrlKey || e.metaKey) && e.key === '\\') {
            e.preventDefault();
            splitEditorGroup();
        }
        if ((e.ctrlKey || e.metaKey) && e.key === 'w') {
            e.preventDefault();
            const group = state.editorGroups.find(g => g.id === state.activeGroup);
            if (group?.activeTab) closeTab(state.activeGroup, group.activeTab);
        }
    });
    
    window.addEventListener('message', (event) => {
        if (event.data?.source === 'iframe-console') {
            const { type, message } = event.data;
            logToConsole(type, message);
        }
    });
}

function renderFileTree() {
    const tree = document.getElementById('file-tree');
    tree.innerHTML = '';
    
    Object.keys(state.files).sort().forEach(filename => {
        const file = state.files[filename];
        const item = document.createElement('div');
        item.className = 'file-tree-item';
        
        const icon = document.createElement('span');
        icon.className = 'icon';
        icon.textContent = filename.endsWith('.html') ? 'üåê' : 
                          filename.endsWith('.css') ? 'üé®' : 
                          filename.endsWith('.js') ? '‚ö°' : 
                          file.isPreview ? 'üîç' : 'üìÑ';
        
        const label = document.createElement('span');
        label.textContent = filename;
        
        item.appendChild(icon);
        item.appendChild(label);
        
        item.addEventListener('click', () => {
            const activeGroupIndex = state.editorGroups.findIndex(g => g.id === state.activeGroup);
            openFile(filename, activeGroupIndex >= 0 ? activeGroupIndex : 0);
        });
        
        tree.appendChild(item);
    });
}

function renderEditorGroups() {
    const container = document.getElementById('editor-groups');
    container.innerHTML = '';
    
    state.editorGroups.forEach((group, index) => {
        const groupEl = createEditorGroup(group);
        container.appendChild(groupEl);
        
        if (index < state.editorGroups.length - 1) {
            const resizer = document.createElement('div');
            resizer.className = 'split-resizer';
            resizer.addEventListener('mousedown', (e) => startResize(e, index));
            container.appendChild(resizer);
        }
    });
}

function createEditorGroup(group) {
    const groupEl = document.createElement('div');
    groupEl.className = 'editor-group';
    
    const header = document.createElement('div');
    header.className = 'editor-group-header';
    
    const tabs = document.createElement('div');
    tabs.className = 'editor-tabs';
    
    group.tabs.forEach(filename => {
        const tab = createTab(filename, group.id, filename === group.activeTab);
        tabs.appendChild(tab);
    });
    
    header.appendChild(tabs);
    
    const actions = document.createElement('div');
    actions.className = 'editor-group-actions';
    
    const splitBtn = document.createElement('button');
    splitBtn.className = 'editor-group-action';
    splitBtn.innerHTML = '‚äû';
    splitBtn.title = 'Split Editor';
    splitBtn.addEventListener('click', () => {
        state.activeGroup = group.id;
        splitEditorGroup();
    });
    
    if (state.editorGroups.length > 1) {
        const closeBtn = document.createElement('button');
        closeBtn.className = 'editor-group-action';
        closeBtn.innerHTML = '√ó';
        closeBtn.title = 'Close Group';
        closeBtn.addEventListener('click', () => closeEditorGroup(group.id));
        actions.appendChild(closeBtn);
    }
    
    actions.appendChild(splitBtn);
    header.appendChild(actions);
    groupEl.appendChild(header);
    
    const content = document.createElement('div');
    content.className = 'editor-content';
    
    if (group.tabs.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'empty-editor';
        empty.textContent = 'No file open';
        content.appendChild(empty);
    } else {
        group.tabs.forEach(filename => {
            const instance = document.createElement('div');
            instance.className = 'editor-instance';
            if (filename === group.activeTab) instance.classList.add('active');
            
            const file = state.files[filename];
            if (file.isPreview) {
                const container = document.createElement('div');
                container.className = 'preview-container';
                const iframe = document.createElement('iframe');
                iframe.sandbox = 'allow-scripts allow-same-origin';
                container.appendChild(iframe);
                instance.appendChild(container);
            } else {
                instance.id = `editor-${group.id}-${filename.replace(/[^a-z0-9]/gi, '-')}`;
            }
            
            content.appendChild(instance);
        });
    }
    
    groupEl.appendChild(content);
    
    setTimeout(() => {
        group.tabs.forEach(filename => {
            const file = state.files[filename];
            if (!file.isPreview) {
                const editorEl = content.querySelector(`#editor-${group.id}-${filename.replace(/[^a-z0-9]/gi, '-')}`);
                if (editorEl && !editorEl.classList.contains('monaco-initialized')) {
                    monaco.editor.create(editorEl, {
                        model: file.model,
                        theme: 'vs-dark',
                        automaticLayout: true,
                        minimap: { enabled: false },
                        fontSize: 14,
                    });
                    editorEl.classList.add('monaco-initialized');
                }
            }
        });
    }, 0);
    
    return groupEl;
}

function createTab(filename, groupId, isActive) {
    const tab = document.createElement('div');
    tab.className = 'editor-tab' + (isActive ? ' active' : '');
    
    const label = document.createElement('span');
    label.textContent = filename;
    
    const close = document.createElement('span');
    close.className = 'editor-tab-close';
    close.innerHTML = '√ó';
    close.addEventListener('click', (e) => {
        e.stopPropagation();
        closeTab(groupId, filename);
    });
    
    tab.appendChild(label);
    tab.appendChild(close);
    
    tab.addEventListener('click', () => switchTab(groupId, filename));
    
    return tab;
}

function openFile(filename, groupIndex = 0) {
    const group = state.editorGroups[groupIndex];
    if (!group) return;
    
    if (group.tabs.includes(filename)) {
        switchTab(group.id, filename);
        return;
    }
    
    group.tabs.push(filename);
    group.activeTab = filename;
    state.activeGroup = group.id;
    
    renderEditorGroups();
    saveState();
}

function closeTab(groupId, filename) {
    const group = state.editorGroups.find(g => g.id === groupId);
    if (!group) return;
    
    const tabIndex = group.tabs.indexOf(filename);
    if (tabIndex === -1) return;
    
    group.tabs.splice(tabIndex, 1);
    
    if (group.activeTab === filename) {
        if (group.tabs.length > 0) {
            group.activeTab = group.tabs[Math.max(0, tabIndex - 1)];
        } else {
            group.activeTab = null;
            if (state.editorGroups.length > 1) {
                closeEditorGroup(groupId);
                return;
            }
        }
    }
    
    renderEditorGroups();
    saveState();
}

function switchTab(groupId, filename) {
    const group = state.editorGroups.find(g => g.id === groupId);
    if (!group) return;
    
    group.activeTab = filename;
    state.activeGroup = groupId;
    
    renderEditorGroups();
    saveState();
}

function splitEditorGroup() {
    const activeGroup = state.editorGroups.find(g => g.id === state.activeGroup);
    if (!activeGroup) return;
    
    const newGroup = {
        id: state.nextGroupId++,
        tabs: activeGroup.activeTab ? [activeGroup.activeTab] : [],
        activeTab: activeGroup.activeTab,
    };
    
    const activeIndex = state.editorGroups.findIndex(g => g.id === state.activeGroup);
    state.editorGroups.splice(activeIndex + 1, 0, newGroup);
    state.activeGroup = newGroup.id;
    
    renderEditorGroups();
    saveState();
}

function closeEditorGroup(groupId) {
    if (state.editorGroups.length === 1) return;
    
    const index = state.editorGroups.findIndex(g => g.id === groupId);
    if (index === -1) return;
    
    state.editorGroups.splice(index, 1);
    
    if (state.activeGroup === groupId) {
        const newIndex = Math.max(0, index - 1);
        state.activeGroup = state.editorGroups[newIndex].id;
    }
    
    renderEditorGroups();
    saveState();
}

function startResize(e, leftIndex) {
    e.preventDefault();
    document.body.classList.add('is-resizing');
    
    const groups = document.querySelectorAll('.editor-group');
    const leftGroup = groups[leftIndex];
    const rightGroup = groups[leftIndex + 1];
    
    const startX = e.clientX;
    const startLeftWidth = leftGroup.offsetWidth;
    const startRightWidth = rightGroup.offsetWidth;
    
    function onMove(e) {
        const delta = e.clientX - startX;
        const newLeftWidth = startLeftWidth + delta;
        const newRightWidth = startRightWidth - delta;
        
        if (newLeftWidth > 200 && newRightWidth > 200) {
            leftGroup.style.flex = `0 0 ${newLeftWidth}px`;
            rightGroup.style.flex = `0 0 ${newRightWidth}px`;
        }
    }
    
    function onUp() {
        document.body.classList.remove('is-resizing');
        document.removeEventListener('mousemove', onMove);
        document.removeEventListener('mouseup', onUp);
    }
    
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
}

function updatePreview() {
    const html = state.files['index.html']?.content || '';
    const css = state.files['style.css']?.content || '';
    const js = state.files['script.js']?.content || '';
    
    const consoleScript = `<script>(function(){const o=console.log,w=console.warn,e=console.error;function s(t,a){window.parent.postMessage({source:'iframe-console',type:t,message:Array.from(a).map(x=>typeof x==='object'?JSON.stringify(x,null,2):String(x)).join(' ')},'*')}console.log=(...a)=>s('log',a);console.warn=(...a)=>s('warn',a);console.error=(...a)=>s('error',a);window.addEventListener('error',e=>s('error',[e.message]))})();</script>`;
    
    let fullHtml = html.replace('<head>', '<head>' + consoleScript);
    
    if (css && fullHtml.includes('</head>')) {
        fullHtml = fullHtml.replace('</head>', `<style>${css}</style></head>`);
    }
    
    if (js && fullHtml.includes('</body>')) {
        fullHtml = fullHtml.replace('</body>', `<script>${js}</script></body>`);
    }
    
    document.querySelectorAll('.preview-container iframe').forEach(iframe => {
        iframe.srcdoc = fullHtml;
    });
}

function openPreviewInNewTab() {
    const html = state.files['index.html']?.content || '';
    const css = state.files['style.css']?.content || '';
    const js = state.files['script.js']?.content || '';
    
    let fullHtml = html;
    if (css) fullHtml = fullHtml.replace('</head>', `<style>${css}</style></head>`);
    if (js) fullHtml = fullHtml.replace('</body>', `<script>${js}</script></body>`);
    
    const blob = new Blob([fullHtml], { type: 'text/html' });
    window.open(URL.createObjectURL(blob), '_blank');
}

function logToConsole(type, message) {
    const entry = document.createElement('div');
    entry.className = `console-entry ${type}`;
    entry.innerHTML = `<span>${type === 'error' ? '‚úñ' : type === 'warn' ? '‚ö†' : '>'}</span><span>${message}</span>`;
    
    const output = document.getElementById('console-output');
    output.appendChild(entry);
    output.scrollTop = output.scrollHeight;
}

function showModal() {
    document.getElementById('modal-overlay').classList.add('active');
    document.getElementById('modal-input').focus();
}

function hideModal() {
    document.getElementById('modal-overlay').classList.remove('active');
    document.getElementById('modal-input').value = '';
}

function handleModalConfirm() {
    const filename = document.getElementById('modal-input').value.trim();
    if (!filename) return;
    
    if (state.files[filename]) {
        alert('File already exists!');
        return;
    }
    
    const ext = filename.split('.').pop();
    const language = ext === 'html' ? 'html' : ext === 'css' ? 'css' : ext === 'js' ? 'javascript' : 'plaintext';
    
    const model = monaco.editor.createModel('', language);
    model.onDidChangeContent(() => {
        state.files[filename].content = model.getValue();
        saveState();
        updatePreview();
    });
    
    state.files[filename] = { language, content: '', model };
    
    renderFileTree();
    openFile(filename, state.editorGroups.findIndex(g => g.id === state.activeGroup));
    hideModal();
    saveState();
}

function saveProject() {
    const html = state.files['index.html']?.content || '';
    const css = state.files['style.css']?.content || '';
    const js = state.files['script.js']?.content || '';
    
    let fullHtml = html;
    if (css) fullHtml = fullHtml.replace('</head>', `<style>${css}</style></head>`);
    if (js) fullHtml = fullHtml.replace('</body>', `<script>${js}</script></body>`);
    
    const blob = new Blob([fullHtml], { type: 'text/html' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'project.html';
    a.click();
}

function saveState() {
    const data = {
        files: {},
        editorGroups: state.editorGroups.map(g => ({ id: g.id, tabs: g.tabs, activeTab: g.activeTab })),
        activeGroup: state.activeGroup,
        consoleOpen: state.consoleOpen,
        nextGroupId: state.nextGroupId,
    };
    
    for (const [filename, file] of Object.entries(state.files)) {
        if (!file.isPreview) {
            data.files[filename] = { language: file.language, content: file.content };
        }
    }
    
    localStorage.setItem('vscode-editor-state', JSON.stringify(data));
}

function loadState() {
    try {
        const saved = localStorage.getItem('vscode-editor-state');
        if (!saved) return;
        
        const data = JSON.parse(saved);
        
        if (data.files) {
            for (const [filename, fileData] of Object.entries(data.files)) {
                if (state.files[filename]?.model) {
                    state.files[filename].content = fileData.content;
                    state.files[filename].model.setValue(fileData.content);
                }
            }
        }
        
        if (data.editorGroups?.length > 0) {
            state.editorGroups = data.editorGroups;
        }
        
        if (data.activeGroup) state.activeGroup = data.activeGroup;
        if (data.consoleOpen !== undefined) {
            state.consoleOpen = data.consoleOpen;
            document.getElementById('console-panel').classList.toggle('collapsed', !state.consoleOpen);
        }
        if (data.nextGroupId) state.nextGroupId = data.nextGroupId;
    } catch (e) {
        console.error('Failed to load state:', e);
    }
}
    </script>
</body>
</html>